<html>
<head>
<script language = "javascript">
var g_fTheta = Math.PI / 4 + 0.00, g_fOmega = 0.01;
var g_arrMassBucket = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
var g_nNumBucket = 8;

var g_fAngleBucketArea = 2 * Math.PI / g_nNumBucket;
var g_fBucketWidth = 0.55; // = (Width of bucket in angle) / (2*pi / # of bucket)

var g_fLenArm = 0.3;

var g_fWaterAdd = 0.5;
var g_fWaterSub = g_fWaterAdd * 0.13;
var g_fWaterMax = 10.0;

var g_fDT = 0.017;


function myGetIdxWater() {
  var nIdxCurr = Math.floor(g_fTheta / g_fAngleBucketArea + 0.5);
  var fRatioAngle = ( g_fTheta - nIdxCurr * g_fAngleBucketArea ) / g_fAngleBucketArea;
  
  return ( Math.abs(fRatioAngle) * 2 <= g_fBucketWidth ? nIdxCurr : -1 );
}


function myCalcNextStep() {
  var i;
  
  var fAccel = 0.0;
  var nIdxTop = myGetIdxWater();
  
  for ( i = 0 ; i < g_nNumBucket ; i++ ) {
    fAccel += Math.sin(g_fTheta - g_fAngleBucketArea * i) * g_arrMassBucket[ i ] * g_fLenArm;
    
    if ( g_arrMassBucket[ i ] > 0.0 ) g_arrMassBucket[ i ] -= g_fWaterSub * g_fDT;
    if ( g_arrMassBucket[ i ] < 0.0 ) g_arrMassBucket[ i ] = 0.0;
  }
  
  if ( nIdxTop >= 0 && g_arrMassBucket[ nIdxTop ] < g_fWaterMax ) {
    g_arrMassBucket[ nIdxTop ] += g_fWaterAdd * g_fDT;
  }
  
  g_fTheta += g_fOmega * g_fDT;
  g_fOmega += fAccel * g_fDT;
  g_fTheta -= Math.floor(g_fTheta / ( 2 * Math.PI )) * 2 * Math.PI;
  
  return 0;
}


function myRunOneFrame() {
  myCalcNextStep();
  
  //console.log(g_fTheta);
  document.getElementById("degree").innerHTML = g_fTheta * 8 / 2 / Math.PI;
  document.getElementById("omega").innerHTML = g_fOmega;
  for ( var i = 0 ; i < 8 ; i++ ) document.getElementById("w" + i).innerHTML = g_arrMassBucket[ i ];
  
  return 0;
}


function main() {
  setInterval("myRunOneFrame()", 17);
  
  return 0;
}
</script>
</head>
<body onload = "main();">
<canvas id = "canvasMain" width = 600 height = 600>
</canvas>
<div id = "degree"></div>
<div id = "omega"></div>
<div id = "w0"></div>
<div id = "w1"></div>
<div id = "w2"></div>
<div id = "w3"></div>
<div id = "w4"></div>
<div id = "w5"></div>
<div id = "w6"></div>
<div id = "w7"></div>
</body>
</html>


